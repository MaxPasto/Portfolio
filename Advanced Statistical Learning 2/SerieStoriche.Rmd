---
title: "Indice di produzione delle costruzioni per Italia e Francia"
author: "Massimiliano Pastorino"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduzione

Il caso studio in esame riguarda l'analisi delle serie storiche relative all'indice di produzione delle Costruzioni per l'Italia e per la Francia. Le serie storiche sono reperibili al seguente link: https://ec.europa.eu/eurostat/databrowser/view/ei_isbu_m/default/table?lang=en

Nella prima parte descriveremo le principali caratteristiche delle serie mentre nella seconda parte verranno implementate reti neurali per prevedere al meglio l'andamento futuro dell'indice considerato. Le osservazioni che rientrano nel periodo Gennaio 1995 - Dicembre 2019 faranno parte del dataset di training per l'addestramebto delle reti neurali, le restanti faranno parte del test set, con esso capiremo quanto male/bene la rete neurale addestrata prevede l'indice considerato. Le serie storiche considerate non presentano effetti dovuti al calendario, sono destagionalizzate e presentano una frequenza mensile. L’indice è normalizzato sul rispettivo livello di produttività del Gennaio 2015 (2015=100). 

# Descrizione serie storiche


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(eurostat)

EI_ISBU_M <- get_eurostat("ei_isbu_m", 
                              stringsAsFactors = FALSE)



Indice_Costruzioni_Italia <- EI_ISBU_M%>%
  filter(geo == "IT", s_adj == "SCA", nace_r2 == "F")%>%
  select(time, values)

  

Indice_Costruzioni_Francia <- EI_ISBU_M%>%
  filter(geo == "FR", s_adj == "SCA", nace_r2 == "F", time >= '1995-01-01' & time <= '2023-03-01')%>%
  select(time, values)



```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tsibble)

Indice_Costruzioni_Italia_Serie_Storica <- Indice_Costruzioni_Italia%>%dplyr::mutate(Mese = yearmonth(time)) %>%
  as_tsibble(index = Mese)%>%
  select(-time)

Indice_Costruzioni_Italia_Serie_Storica <- Indice_Costruzioni_Italia_Serie_Storica[,c(2,1)]

colnames(Indice_Costruzioni_Italia_Serie_Storica) <- c("Mese", "Osservazione")

```



```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tsibble)

Indice_Costruzioni_Francia_Serie_Storica <- Indice_Costruzioni_Francia%>%dplyr::mutate(Mese = yearmonth(time)) %>%
  as_tsibble(index = Mese)%>%
  select(-time)

Indice_Costruzioni_Francia_Serie_Storica <- Indice_Costruzioni_Francia_Serie_Storica[,c(2,1)]

colnames(Indice_Costruzioni_Francia_Serie_Storica) <- c("Mese", "Osservazione")

```


Dalle serie storiche notiamo come l'indice di produzione delle costruzioni ha avuto dei brevi periodi di recessione e dei brevi periodi di espansione, questo se si guarda al periodo 1995-2008, in linea generale notiamo un trend comunque crescente. 

Con la crisi derivante dalla caduta di Lehman Brothers nell'anno 2008, notiamo la recessione che ha subito l'indice di produzione delle costruzioni con il conseguente trend decrescente che si è protratto negli anni avvenire.

Successivamente abbiamo avuto un periodo di stabilizzazione. Con l'avvento del covid nell'anno 2020 notiamo ancora una volta una recessione dell'indice considerato. Infine negli ultimi anni notiamo una ripresa del settore.

Dall'analisi notiamo due break strutturali molto forti che hanno influenzato il settore delle costruzioni (2008: Caduta della Lehman Brothers, 2020: Covid).


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

library(ggplot2)
ggplot(Indice_Costruzioni_Italia_Serie_Storica, aes(x=Mese, y = Osservazione, color = "ITALIA")) + geom_line(size = 1) + geom_line(aes(x = Indice_Costruzioni_Francia_Serie_Storica$Mese, y = Indice_Costruzioni_Francia_Serie_Storica$Osservazione, color = "FRANCIA"),size = 1) + ggtitle("Indice di Produzione delle Costruzioni")  +  theme_bw() + xlab("Anni") + scale_color_manual(
    name='NAZIONE',
    values=c('red','black'))



```


Con l'utilizzo delle medie mobili possiamo stimare la componente di trend-cycle di una data serie storica. La stima del trend-cycle al tempo t è ottenuta grazie alla media dei valori entro k periodi di t. 

L'ordine m di una media mobile determina quanto smooth è la stima della componente di trend-cycle. In generale un'ordine più grande fornisce una stima più smooth di tale componente come possiamo notare dal grafico. 

Una media mobile di ordine 5 considera tutte quelle osservazioni che rientrano nella finestra quinquennale centrata sull'anno corrispondente, quindi per i primi e per gli ultimi due anni non sarà possibile calcolare il valore della media mobile in quanto non abbiamo i valori osservati.



```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
Indice_Costruzioni_Italia_Serie_Storica_ma <- Indice_Costruzioni_Italia_Serie_Storica %>%
mutate(
'5-MA' = slider::slide_dbl(Osservazione, mean,
.before = 2, .after = 2, .complete = TRUE),
'9-MA' = slider::slide_dbl(Osservazione, mean,
.before = 4, .after = 4, .complete = TRUE)
)


Indice_Costruzioni_Francia_Serie_Storica_ma <- Indice_Costruzioni_Francia_Serie_Storica %>%
mutate(
'5-MA' = slider::slide_dbl(Osservazione, mean,
.before = 2, .after = 2, .complete = TRUE),
'9-MA' = slider::slide_dbl(Osservazione, mean,
.before = 4, .after = 4, .complete = TRUE)
)


medie_mobili_italia <- ggplot(Indice_Costruzioni_Italia_Serie_Storica_ma, aes(x=Mese, y = Osservazione)) + geom_line(size = 1) + geom_line(aes(x = Indice_Costruzioni_Italia_Serie_Storica_ma$Mese, y = Indice_Costruzioni_Italia_Serie_Storica_ma$`5-MA`, colour = "5-MA"),size = 1) + geom_line(aes(x = Indice_Costruzioni_Italia_Serie_Storica_ma$Mese, y =  Indice_Costruzioni_Italia_Serie_Storica_ma$`9-MA`, colour = "9-MA"),size = 1) + ggtitle("Indice di Produzione delle Costruzioni per l'Italia")  +  theme_bw() + xlab("Anni")  + scale_color_manual(
    name='Media Mobile',
    values=c('red','blue')) 





medie_mobili_francia <- ggplot(Indice_Costruzioni_Francia_Serie_Storica_ma, aes(x=Mese, y = Osservazione)) + geom_line(size = 1) + geom_line(aes(x = Indice_Costruzioni_Francia_Serie_Storica_ma$Mese,y = Indice_Costruzioni_Francia_Serie_Storica_ma$`5-MA`, colour = "5-MA"),size = 1) + geom_line(aes(x = Indice_Costruzioni_Francia_Serie_Storica_ma$Mese, y = Indice_Costruzioni_Francia_Serie_Storica_ma$`9-MA`, colour = "9-MA"),size = 1) + ggtitle("Indice di Produzione delle Costruzioni per la Francia")  +  theme_bw() + xlab("Anni")  + scale_color_manual(
    name='Media Mobile',
    values=c('red','blue'))

gridExtra::grid.arrange(medie_mobili_italia, medie_mobili_francia)





```

# Test di linearità

Molte serie storiche osservate esibiscono caratteristiche che non possono essere spiegate da un modello lineare, infatti molti problemi complessi nel mondo reale sono spesso non lineari, pensiamo ad esempio alle serie storiche finanziarie.

Applicare un modello lineare ad una serie storica sarebbe totalmente inappropriato qualora essa fosse in realtà generata da un processo non
lineare. 

Per asserire la linearità di una serie storica possiamo considerare il test di Terasvirta e il test di White. 

L'ipotesi nulla riguarda la linearità in media della serie storica. Il risultato del test Terasvirta indica un p-value minore di 0.05, in questo caso possiamo dire che l’evidenza empirica è fortemente contraria all’ipotesi nulla che quindi va rifiutata, rifiutiamo l'ipotesi di linearità in media della serie storica dell'indice di produzione delle costruzioni dell'Italia.

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(tseries)
terasvirta.test(as.ts(Indice_Costruzioni_Italia_Serie_Storica))
```

Stesso discorso vale per la serie storica dell'indice di produzione delle costruzioni della Francia. Anche in questo caso possiamo asserire la non linearità in media della serie storica considerata.

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(tseries)
terasvirta.test(as.ts(Indice_Costruzioni_Francia_Serie_Storica))
```

Anche il test di White è utile per asserire la linearità in media della serie storica considerata. Dai risultati del test di White possiamo possiamo asserire la non linearità in media delle serie storiche considerate.

Alla luce dei risultati ottenuti, per entrambe le serie storiche verranno implementate delle reti neurali auto regressive single layer.


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
white.test(as.ts(Indice_Costruzioni_Italia_Serie_Storica))
```


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
white.test(as.ts(Indice_Costruzioni_Francia_Serie_Storica))
```

# Reti neurali

Per prevedere l'andamento dell'indice di produzione delle costruzioni possiamo addestrare una rete neurale con il comando nnetar della libreria forecast.

Come già detto nell'introduzione, le osservazioni che rientrano nel periodo Gennaio 1995 - Dicembre 2019 faranno parte del dataset di training.

In questo caso la rete neurale è stata implementata considerando i seguenti parametri:

* p: Pari a 5, esso rappresenta il numeri di ritardi (lags) utilizzati come input. Il numero di ritardi stagionali (P) utilizzati come input è pari a 0 in quanto le serie storiche prese in considerazione sono seasonally adjusted. 

* size: Pari a 3, esso rappresenta il numero di neuroni che compongono il singolo strato nascosto della rete neurale. 

* repeats: Pari a 20, esso rappresenta il numero di reti neurali addestrate con dei pesi iniziali casuali differenti. 

* Funzione di attivazione per lo strato nascosto: Logit

* Funzione di attivazione per l'output: Linear

Dai grafici possiamo confrontare i valori osservati con i valori stimati dalla rete neurale. Notiamo che la rete neurale implementata è riuscita a cogliere l'andamento generale degli indici di produzione delle costruzioni delle nazioni considerate soprattutto se si guarda l'Italia. Notiamo che in alcuni periodi la rete neurale tende a sovrastimare l'indice considerato, questo accade soprattutto in quelle fasi di recessione, ed in particolar modo per la Francia.


```{r,echo=FALSE, warning=FALSE, message=FALSE}
## Indice_Costruzioni_Italia_Serie_Storica[300,] Dicembre 2019
## Indice_Costruzioni_Francia_Serie_Storica[300,] Dicembre 2019

training_Indice_Costruzioni_Italia_Serie_Storica <- Indice_Costruzioni_Italia_Serie_Storica[1:300,]


training_Indice_Costruzioni_Francia_Serie_Storica <- Indice_Costruzioni_Francia_Serie_Storica[1:300,]


test_Indice_Costruzioni_Italia_Serie_Storica <- Indice_Costruzioni_Italia_Serie_Storica[301:339,]


test_Indice_Costruzioni_Francia_Serie_Storica <- Indice_Costruzioni_Francia_Serie_Storica[301:339,]
```

```{r,echo=FALSE, warning=FALSE, message=FALSE}
library(forecast)

set.seed(300399)

fit_italia <- nnetar(as.ts(training_Indice_Costruzioni_Italia_Serie_Storica), p = 5, P=0, size = 3, repeats = 20)

set.seed(300399)

fit_francia <- nnetar(as.ts(training_Indice_Costruzioni_Francia_Serie_Storica), p = 5, P=0, size = 3, repeats = 20)

```




```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
grafico_italia <- ggplot(training_Indice_Costruzioni_Italia_Serie_Storica, aes(x=Mese, y=Osservazione, colour = "Osservati")) + geom_line(size = 1) + geom_line(aes(x=training_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=fit_italia$fitted, colour = "Stimati"),size = 1) + theme_bw() + ylab("Anni") + ggtitle("NNAR(5,3) Gennaio 1995 - Dicembre 2019 (Italia)") + scale_color_manual(
    name='Valori',
    values=c('black','red'))


grafico_francia <-  ggplot(training_Indice_Costruzioni_Francia_Serie_Storica, aes(x=Mese, y=Osservazione, colour = "Osservati")) + geom_line(size = 1) + geom_line(aes(x=training_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=fit_francia$fitted, colour = "Stimati"),size = 1) + theme_bw() + ylab("Anni") + ggtitle("NNAR(5,3) Gennaio 1995 - Dicembre 2019 (Francia)") + scale_color_manual(
    name='Valori',
    values=c('black','red'))


gridExtra::grid.arrange(grafico_italia, grafico_francia)
```

Utilizziamo le reti neurali NNAR(5,3) addestrate sui dati di training per prevedere sui dati unseen (test set) l'andamento dell'indice di produzione delle costruzioni. Dai grafici possiamo notare come il covid abbia influito in modo negativo sull'indice considerato. In questo caso possiamo comparare i due scenari, con e senza covid.

In assenza di covid dalla stima puntuale possiamo notare una sorta di periodo di stabilizzazione dell'indice considerato, mentre nel caso reale, quello legato all'effetto covid, notiamo due fasi, la prima (Anno 2020) in cui l'indice considerato ha subito una netta recessione, ed una seconda in cui dopo il primo periodo pandemico l'indice considerato ha avuto una fase di ricrescita. Questo vale per ambo le nazioni. 



```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
previsioni_test_Italia <- fit_italia%>%
  forecast(h = 39, PI = TRUE, level = c(80,95))


pred_Italia <- as.data.frame(previsioni_test_Italia)[,1:5]


test_Italia <- ggplot(test_Indice_Costruzioni_Italia_Serie_Storica, aes(x=Mese, y=Osservazione, colour = "Osservati")) + geom_line(size = 1) + geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y = pred_Italia$`Point Forecast`, colour = "Previsione puntuale"),size = 1) +
geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=pred_Italia$`Lo 95`, colour = "Intervallo di confidenza all' 95%"),size = 1) +  geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=pred_Italia$`Hi 95`, colour = "Intervallo di confidenza all' 95%"),size = 1) +theme_bw() + xlab("Anni") + ggtitle("Previsioni sul Test Set (Italia)") + scale_color_manual(
    name='Valori',
    values=c('blue', 'black', 'red'))


previsioni_test_Francia <- fit_francia%>%
    forecast(h = 39, PI = TRUE, level = c(80,95))


pred_Francia <- as.data.frame(previsioni_test_Francia)[,1:5]



test_Francia <- ggplot(test_Indice_Costruzioni_Francia_Serie_Storica, aes(x=Mese, y=Osservazione, colour = "Osservati")) + geom_line(size = 1) + geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y = pred_Francia$`Point Forecast`, colour = "Previsione puntuale"),size = 1) +
geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=pred_Francia$`Lo 95`, colour = "Intervallo di confidenza all' 95%"),size = 1) +  geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=pred_Francia$`Hi 95`, colour = "Intervallo di confidenza all' 95%"),size = 1) +theme_bw() + xlab("Anni") + ggtitle("Previsioni sul Test Set (Francia)") + scale_color_manual(
    name='Valori',
    values=c('blue', 'black', 'red'))

gridExtra::grid.arrange(test_Italia, test_Francia)

```


Valori osservati e valori previsti per l'Italia (Forma tabellare)

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
confronto_Italia <- cbind.data.frame(test_Indice_Costruzioni_Italia_Serie_Storica$Mese,test_Indice_Costruzioni_Italia_Serie_Storica$Osservazione, pred_Italia$`Point Forecast`)

colnames(confronto_Italia) <- c("Data", "Valore Osservato", "Valore previsto")

as_tibble(confronto_Italia)

```


Valori osservati e valori previsti per la Francia (Forma tabellare)

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
confronto_Francia <- cbind.data.frame(test_Indice_Costruzioni_Francia_Serie_Storica$Mese,test_Indice_Costruzioni_Francia_Serie_Storica$Osservazione, pred_Francia$`Point Forecast`)

colnames(confronto_Francia) <- c("Data", "Valore Osservato", "Valore previsto")

as_tibble(confronto_Francia)

```



Per incrementare le performance della rete neurale possiamo pensare di implementare una cross-validation per serie storiche per selezionare i parametri di ottimizzazione.

Gli iperparametri presi in considerazione sono:

* p: Consideriamo una sequenza di ritardi (lags) utilizzati come input che va da un numero minimo pari a 1 a un numero massimo pari a 10.

* size: Consideriamo una sequenza di neuroni intermedi che va da un numero minimo pari a 1 a un numero massimo pari a 10.

* Weight Decay: Consideriamo una sequenza di 10 weight decay compresi nel range [1e-10, 1].


La strategia di resampling implementata attraverso il comando time_series_cv della libreria timetk è la seguente:

* Initial: Pari a 5 anni, esso rappresenta il numero di osservazioni temporali che comporranno il training set.

* Assess: Pari a 2 anni, esso rappresenta il numero di osservazioni temporali che comporranno il test set.

* Skip: Pari a 2 anni, ovvero ad ogni iterazione della time series cross validation ci sposteremo in avanti di due anni per prendere quelle osservazioni che comporranno il nuovo training set sempre di dimensione pari a 5 anni.

* Cumulative = FALSE, ovvero il ricampionamento avviene su una finestra fissa che in questo caso è specificata dal parametro Initial.

* slice_limit: Con i parametri impostati in precedenza esso è pari a 10.

Per ogni combinazione degli iperparametri presi in considerazione verrà stimata una rete neurale. Dopo l'ultima iterazione della time series cross validation  avremo 10 metriche di performance, ognuna calcolata sul test set relativo allo slice di riferimento. 

Le 10 metriche di performance verranno aggregate per ottenere un’unica metrica finale. Verrà scelta quella particolare combinazione di iperparametri che garantisce il miglior root mean squared error in cross-validation.



Osservando la tabella possiamo notare come varia il root mean squared error medio in funzione dei 3 iperparametri considerati. Per l'Italia il miglior modello con l’RMSE più basso in cross-validation presenta un numero di ritardi utilizzati come input pari a 3, un numero di neuroni intermedi pari a 6, e un weight decay pari a 0.006.


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

## ITALIA

library(timetk)
library(modeltime)
library(tidymodels)
library(dplyr)
library(lubridate)

Indice_Costruzioni_Italia <- Indice_Costruzioni_Italia%>%arrange(ymd(Indice_Costruzioni_Italia$time))

set.seed(300399)

resampling_strategy <- 
  Indice_Costruzioni_Italia[1:300,] %>%
  time_series_cv(
    date_var = time,
    initial = "5 years",
    assess = "2 years",
    skip = "2 years",
    cumulative = FALSE
  )


tune_nnetar_model <-
  nnetar_reg(
    non_seasonal_ar = tune(),
    hidden_units = tune(),
    penalty = tune()
  ) %>%
  set_engine("nnetar", 
             scale.inputs = FALSE) %>%
  set_mode("regression")

nn_grid <- grid_regular(
  non_seasonal_ar(range = c(1L, 10L)),
  hidden_units(range = c(1L, 10L)),
  penalty(),
  levels = c(10,10,10)
)

simple_rec <- recipe(values ~ time, data = Indice_Costruzioni_Italia[1:300,])

nnetar_workflow <- 
  workflow() %>% 
  add_model(tune_nnetar_model) %>% 
  add_recipe(simple_rec)



doParallel::registerDoParallel()

set.seed(300399)

tune_results <- nnetar_workflow %>% 
  tune_grid(
    resamples = resampling_strategy,
    grid = nn_grid,
    metrics = metric_set(rmse))



best_results <- tune_results %>%
    show_best(metric = 'rmse')

best_results[,c(1,2,3,6)]
```


Per la Francia il miglior modello con l’RMSE più basso in cross-validation presenta un numero di ritardi utilizzati come input pari a 1, un numero di neuroni intermedi pari a 3, e un weight decay pari a 0.07.


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(timetk)
library(modeltime)
library(tidymodels)
library(dplyr)
library(lubridate)

Indice_Costruzioni_Francia <- Indice_Costruzioni_Francia%>%arrange(ymd(Indice_Costruzioni_Francia$time))

set.seed(300399)

resampling_strategy <- 
  Indice_Costruzioni_Francia[1:300,] %>%
  time_series_cv(
    date_var = time,
    initial = "5 years",
    assess = "2 years",
    skip = "2 years",
    cumulative = FALSE
  )


tune_nnetar_model <-
  nnetar_reg(
    non_seasonal_ar = tune(),
    hidden_units = tune(),
    penalty = tune()
  ) %>%
  set_engine("nnetar", 
             scale.inputs = FALSE) %>%
  set_mode("regression")

nn_grid <- grid_regular(
  non_seasonal_ar(range = c(1L, 10L)),
  hidden_units(range = c(1L, 10L)),
  penalty(),
  levels = c(10,10,10)
)

simple_rec <- recipe(values ~ time, data = Indice_Costruzioni_Francia[1:300,])

nnetar_workflow <- 
  workflow() %>% 
  add_model(tune_nnetar_model) %>% 
  add_recipe(simple_rec)



doParallel::registerDoParallel()

set.seed(300399)

tune_results <- nnetar_workflow %>% 
  tune_grid(
    resamples = resampling_strategy,
    grid = nn_grid,
    metrics = metric_set(rmse))



best_results_Francia <- tune_results %>%
    show_best(metric = 'rmse')

best_results_Francia[,c(1,2,3,6)]
```



I modelli scelti verranno addestrati sui rispettivi training set (Gennaio 1995-Dicembre 2019), infine essi verranno utilizzati per prevedere l'andameto dell'indice di produzione delle costruzioni d'Italia e Francia per il periodo (Gennaio 2020-Marzo 2023).


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
set.seed(300399)
best_net_Italia <- nnetar(training_Indice_Costruzioni_Italia_Serie_Storica$Osservazione, p=3, P=0, size=6, repeats = 20 ,decay=0.005994843)

set.seed(300399)
best_net_Francia <- nnetar(training_Indice_Costruzioni_Francia_Serie_Storica$Osservazione, p=1, P=0, size=3, repeats = 20 ,decay=0.0774263683)

```

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
set.seed(300399)

previsioni_test_Italia_best_net <- best_net_Italia%>%
  forecast(h = 39, PI = TRUE, level = c(95))


pred_Italia_best_net <- as.data.frame(previsioni_test_Italia_best_net)[,1:3]


set.seed(300399)

previsioni_test_Francia_best_net <- best_net_Francia%>%
  forecast(h = 39, PI = TRUE, level = c(95))


pred_Francia_best_net <- as.data.frame(previsioni_test_Francia_best_net)[,1:3]

```

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
ggplot(test_Indice_Costruzioni_Italia_Serie_Storica, aes(x=Mese, y=Osservazione, colour = "Osservati")) + geom_line(size = 1) + 
geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y = pred_Italia$`Point Forecast`, colour = "Previsione puntuale NNAR(5,3)"), size = 1) +
geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=pred_Italia$`Lo 95`, colour = "Intervallo di confidenza all' 95% NNAR(5,3)"),size = 1) +  geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=pred_Italia$`Hi 95`, colour = "Intervallo di confidenza all' 95% NNAR(5,3)"),size = 1) + 
geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y = pred_Italia_best_net$`Point Forecast`, colour = "Previsione puntuale NNAR(3,6) CON WD=0.006"),size = 1) +
geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=pred_Italia_best_net$`Lo 95`, colour = "Intervallo di confidenza all' 95% NNAR(3,6) CON WD=0.006"),size = 1) +  geom_line(aes(x=test_Indice_Costruzioni_Italia_Serie_Storica$Mese, y=pred_Italia_best_net$`Hi 95`, colour = "Intervallo di confidenza all' 95% NNAR(3,6) CON WD=0.006"),size = 1) + theme_bw() + xlab("Anni") + ggtitle("Previsioni sul Test Set (Italia)") + scale_color_manual(
    name='Valori',
    values=c('brown4', 'cyan4', 'black', 'brown3', 'cyan3'))


```


Valori osservati e valori previsti per l'Italia (Forma tabellare)


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
confronto_Italia$NNA36WD <- pred_Italia_best_net$`Point Forecast`
colnames(confronto_Italia) <- c("Data", "Valore Osservato", "Valore previsto NNAR(5,3)", "Valore previsto NNAR(3,6) CON WD=0.006")

as_tibble(confronto_Italia)

```



Metriche di performance sul test set per l'Italia

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
metriche_Ita_nnetar1 <- round(forecast::accuracy(previsioni_test_Italia$mean, Indice_Costruzioni_Italia$values[301:339]),1)


metriche_Ita_best_nnetar <- round(forecast::accuracy(previsioni_test_Italia_best_net$mean, Indice_Costruzioni_Italia$values[301:339]),1)

metriche_Ita_confronto <- rbind(metriche_Ita_nnetar1, metriche_Ita_best_nnetar)

rownames(metriche_Ita_confronto) <- c("NNAR(5,3)", "NNAR(3,6) CON DECAY = 0.006")
                              
as.data.frame(metriche_Ita_confronto)
```


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
ggplot(test_Indice_Costruzioni_Francia_Serie_Storica, aes(x=Mese, y=Osservazione, colour = "Osservati")) + geom_line(size = 1) + 
geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y = pred_Francia$`Point Forecast`, colour = "Previsione puntuale NNAR(5,3)"),size = 1) +
geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=pred_Francia$`Lo 95`, colour = "Intervallo di confidenza all' 95% NNAR(5,3)"),size = 1) +  geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=pred_Francia$`Hi 95`, colour = "Intervallo di confidenza all' 95% NNAR(5,3)"),size = 1) + 
geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y = pred_Francia_best_net$`Point Forecast`, colour = "Previsione puntuale NNAR(1,3) CON WD=0.07"),size = 1) +
geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=pred_Francia_best_net$`Lo 95`, colour = "Intervallo di confidenza all' 95% NNAR(1,3) CON WD=0.07"),size = 1) +  geom_line(aes(x=test_Indice_Costruzioni_Francia_Serie_Storica$Mese, y=pred_Francia_best_net$`Hi 95`, colour = "Intervallo di confidenza all' 95% NNAR(1,3) CON WD=0.07"),size = 1) + theme_bw() + xlab("Anni") + ggtitle("Previsioni sul Test Set (Francia)") + scale_color_manual(
    name='Valori',
    values=c('brown4', 'cyan4', 'black', 'brown3', 'cyan3'))
```


Valori osservati e valori previsti per la Francia (Forma tabellare)

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
confronto_Francia$NNA13WD <- pred_Francia_best_net$`Point Forecast`
colnames(confronto_Francia) <- c("Data", "Valore Osservato", "Valore previsto NNAR(5,3)", "Valore previsto NNAR(1,3) CON WD=0.07")

as_tibble(confronto_Francia)
```

Metriche di performance sul test set per la Francia


```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
metriche_Fra_nnetar1 <- round(forecast::accuracy(previsioni_test_Francia$mean, Indice_Costruzioni_Francia$values[301:339]),1)


metriche_Fra_best_nnetar <- round(forecast::accuracy(previsioni_test_Francia_best_net$mean, Indice_Costruzioni_Francia$values[301:339]),1)

metriche_Fra_confronto <- rbind(metriche_Fra_nnetar1, metriche_Fra_best_nnetar)

rownames(metriche_Fra_confronto) <- c("NNAR(5,3)", "NNAR(1,3) CON DECAY = 0.07")
                              
as.data.frame(metriche_Fra_confronto)
```








